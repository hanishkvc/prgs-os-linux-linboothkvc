Readme - linboothkvc
v15Jan2012_0127
HKVC, GPL
A linux kernel module based bootstrap loader
----------------------------------------------

>> 15Jan2012 <<

Have completed the qemu beaglexm based linboothkvc (kexec) FULLY Now. Now from
with in a running linux system in qemu, you can restart a new linux kernel and its
user space.

For this currently it uses the x-loader itself to bootstrap u-boot.bin and inturn
the linux kernel, similar to how the hardware bootrom does it on power on. This
new x-load.bin image is embedded within the kernel module.

I have updated the kernel module such that it takes 2 images into itself.

Image 1 == The Nirvana Code (Example - bloop?.S, omap3callbootrom1.S, ...)
This gets passed the control once the kernel module is done with disabling interrupts,
disabling mmu (something seems to be missing wrt this with the latest changes I did
to accomodate Nirvana and Nirvana's child, have to debug later), setting up the
1 to 1 mmu map, etc.

In turn currently the nirvana code omap3callbootrom1.S takes care of disabling mmu,
interrupts etc once again just to be safe. And inturn it loads the NirvanaChild code
into 0x4020.0800 similar to how Omap3 bootrom loader does its job, and inturn calls
the entry point at 0x4001.4000 in the bootrom. This takes care of setting up the
stack and calling the NirvanaChild Code.

Image 2 == The NirvanaChild Code (Example - x-load.bin (without signGP))
The address and length of this code is passed to Nirvana Code thro r0 and r1
respectively. It is upto Nirvana code to decide what it will do with this image.

As of today only the omap3callbootrom1.S nirvana code handles this image as required
while the older nirvana codes don't know about this.

NOTE: misc/Binaries/HKVC-x-load.bin - Currently the new x-load.bin is expected to be
with in misc/Binaries/HKVC-x-load.bin in the linboothkvc subfolder.

If you want to experiment with a new x-loader or any other bootloader, then copy it
to above mentioned location and then run the following.

./hkvc-make clean
./hkvc-make nchild
./hkvc-make asm
./hkvc-make

Next copy the lbhkvc_km_DEVICE_BEAGLEXM.ko to qemu running linux (for which you
compiled the kernel module). and insmod the kernel module and see the magic :-)

>> 14Jan2012 <<

Step1 [DONE]: Basic logic working in QEmu BeagleboardXM correctly now. Becaue Qemu doesn't
similate Cache fully the bug related cache handling doesn't affect it. Qemu based snooping
allowd me to identify my stupid mistake of not setting flags in my nirvana code samples.
Also it helped me to run thro the boot flow as well as few other aspects of the shutdown
process fully like identifying the MMU wasn't disabled by the kernel support routine
(Now come on who wants to read thro the code carefully to identify these same, when one can
experiment with the flow in qemu (lazzy me) :-) among others. My only peeve with Qemu
is the way it maps the serial port to stdio or ptys rather indirectly arbitrarily to some
extent.


Step2 [Next]: Next have to fix my known bugs and try on actual BeagleboardXM, now that
I have got hold of xds100v2 yesterday and inturn able to debug Beagle using openocd.
Rather put the required asm code directly instead of calling the hidden kernel functions.

Step3 [After]: With the above two, most probably the code should run straight on Nook also
as I have already taken care of shutting the 2nd proc down. Any additional SMP sync logic
if any in chip to be looked at beyond the ISB and DSB syncing wrt current cpu.

NOTE: jtag access as allowed me to confirm my suspisions wrt cache


>> 08+Jan2012 <<
Moving away from directly trying on NookTab to experiment with qemu initially to help
debug the code easily (instead of requiring to experiment with uart prints).


Bugs - TOFIX
---------------

>> 14Jan2012 <<

The code to execute which is copied to kmalloced location, doesn't seem to be flushed
to memory successfully always. This is also one serious issue affecting my kexec working
currently. Have to look at cache flushing kernel function which I have used properly
tomorrow and if required replace it or, have to move the code to copy to final location
in my code in innermost kexec after it disables interrupts and calls DSB and ISB (just to
be safe, even thou DSB and ISB doesn't seem to be helping here).

Also the patch to the kernel module by insmod support logic in kernel to resolve the
external symbols used in the module itself seems to be NOT fully flushed back into memory
from cache sometimes.



MISC
---------------

>> 12Jan2012 <<

***N*** Omap3 Bootrom
0x40014000 - start of BootRom
0x40014040 - Start Addr saved ?
0x40014044 - Boot message structure


>> 13Jan2012 <<

***N*** Omap3730 linux kernel after proc_fin and setup_mm_for_reboot

**** SCTLR
IF
	MRC p15, 0, <Rt>, c1, c0, 0
THEN
	Rt = 0x10c52c79 (QEmu-BeagleXM)
	Rt = 0x10c52c79 (NookTab)
	Rt = 0x10C52879 (BeaglXM)

